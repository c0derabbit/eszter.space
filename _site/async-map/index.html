<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async Array.map(): how to await an array with API calls for each item?</title>
    <meta name="description" content="">
    <link rel="alternate" href="." type="application/atom+xml" title="">
    <link rel="alternate" href="." type="application/json" title="">
  </head>
  <body>
    <header>
      <h1><a href="/"></a></h1>
    </header>

    <main>
      <h1>Async Array.map(): how to await an array with API calls for each item?</h1>

<p>Today we’ll explore how to use Promises[^1] within Array methods. For our example, we will look up coordinates for places on <a href="https://developer.here.com/documentation/geocoder/topics/quick-start-geocode.html">Here API</a>.</p>
<p>Let’s try to do it the naïve way (like itʼs the first time we do anything async).</p>
<pre><code class="language-js">const axios = require('axios');

const baseUrl = 'https://geocoder.api.here.com/6.2/geocode.json';
const places = ['beirut', 'london']; 	
const hereAppCode = 'yourAppCode';
const hereAppId = 'yourAppId';

function getCoords(name) {
  return axios.get(
    `${baseUrl}?app_id=${hereAppId}&amp;app_code=${hereAppCode}&amp;searchtext=${name}`
  );
}

const placesWithCoords = places.map(place =&gt; {
  getCoords(place)
    .then(res =&gt; {
      console.log(`in map(): ${res.data}`);
      return res.data;
    })
    .catch(err =&gt; {
      console.error(err);
    });
});

console.log(`after map(): ${placesWithCoords}`);

// -&gt; after map(): [ undefined, undefined ] (⚠️ this gets called first!)
// -&gt; in map(): { Response: … } }
// -&gt; in map(): { Response: … } }
</code></pre>
<p>Why does this fail?</p>
<p>Because the <code>console.log</code> after mapping does not wait for the promises to finish. Letʼs try something different then: wait for all promises to finish before we do anything with the result.</p>
<p>With a combination of <code>async</code>, <code>await</code> and <code>Promise.all()</code>, it’s giving somewhat better results:</p>
<pre><code class="language-js">function getCoords(name) {
  return axios.get(
    `${baseUrl}?app_id=${hereAppId}&amp;app_code=${hereAppCode}&amp;searchtext=${name}`
  );
}

async function getPlacesWithCoords() {
  const withCoords = await Promise.all(places.map(place =&gt; getCoords(place)));
  console.log(`in async function: ${withCoords}`);
  return withCoords;
}

const placesWithCoords = getPlacesWithCoords();
console.log(`after async function: ${placesWithCoords}`);

// -&gt; after async function: Promise { &lt;pending&gt; }
// -&gt; in async function: [ …data ]
</code></pre>
<p>Much better, now we have a Promise to work with. We just have to add <code>.then(…)</code> to the end and do with the results what we like.</p>
<pre><code class="language-js">async function getPlacesWithCoords() {
  const withCoords = await Promise.all(places.map(place =&gt; getCoords(place)));
  console.log('in async function:', withCoords);
  return withCoords;
}

getPlacesWithCoords().then(res =&gt; console.log('after async function:', res));

// -&gt; in async function: [ …data ]
// -&gt; after async function: [ …data ]
</code></pre>
<p>Thatʼs it! If you only need this function once, you can even wrap it in a <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE">self-executing anonymous function</a> and do:</p>
<pre><code class="language-js">(async function() {
  const withCoords = await Promise.all(places.map(place =&gt; getCoords(place)));
  // do something with the result
})()
</code></pre>
<hr>
<h4>Notes</h4>
<p>[^1]: “The <strong>Promise</strong> object represents the eventual completion (or failure) of an asynchronous operation, and its resulting value.” — <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise on MDN</a></p>


<hr>
<ul><li>Next: <a href="/cv-opinion/">Iʼve reviewed lots of CVs recently. Hereʼs how to improve yours</a></li><li>Previous: <a href="/copy-tooltip/">Friendly UIs: Let users copy with a click</a></li>
</ul>

    </main>

    <footer></footer>

    <!-- Current page: /async-map/ -->
  </body>
</html>
